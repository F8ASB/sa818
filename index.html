<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Configuration SA818 ‚Äî CTCSS en fr√©quence</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    fieldset { margin-bottom: 20px; padding: 15px; border-radius: 8px; }
    legend { font-weight: bold; }
    label { display: inline-block; width: 160px; margin-bottom: 6px; vertical-align: top; }
    input, select { padding: 4px; margin-bottom: 8px; }
    button { margin-top: 10px; padding: 6px 12px; }
    #topButtons { margin-bottom: 20px; }
    #log { border: 1px solid #ccc; padding: 10px; margin-top: 15px; height: 220px; overflow-y: auto; background: #f9f9f9; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Contr√¥le du module SA818 V1.0 - F8ASB</h1>

  <div id="topButtons">
    <button id="connectBtn">üîå Choisir un port COM</button>
    <button id="readConfigBtn">üìñ Lire configuration</button>
    <button id="readVersionBtn">‚ÑπÔ∏è Lire version</button>
  </div>

  <fieldset>
    <legend>Groupe (fr√©quences, CTCSS, SQ)</legend>
    <label>Bande passante :</label>
    <select id="gbw">
      <option value="0">12.5 kHz</option>
      <option value="1">25 kHz</option>
    </select><br>

    <label>Fr√©quence TX (MHz) :</label>
    <input type="text" id="txFreq" value="433.5000"><br>

    <label>Fr√©quence RX (MHz) :</label>
    <input type="text" id="rxFreq" value="433.5000"><br>

    <label>CTCSS TX :</label>
    <select id="txCss"></select><br>

    <label>Niveau Squelch :</label>
    <input type="number" id="squelch" min="0" max="8" value="4"><br>

    <label>CTCSS RX :</label>
    <select id="rxCss"></select><br>

    <button id="setGroupBtn">‚úÖ Appliquer</button>
  </fieldset>

  <fieldset>
    <legend>Volume</legend>
    <label>Niveau :</label>
    <input type="number" id="volume" min="1" max="8" value="4"><br>
    <button id="setVolumeBtn">‚úÖ Appliquer</button>
  </fieldset>

  <fieldset>
    <legend>Filtres</legend>
    <label>Pr√©/d√©-emphasis :</label>
    <select id="preemph"><option value="0">ON</option><option value="1">OFF</option></select><br>

    <label>High-pass :</label>
    <select id="highpass"><option value="0">ON</option><option value="1">OFF</option></select><br>

    <label>Low-pass :</label>
    <select id="lowpass"><option value="0">ON</option><option value="1">OFF</option></select><br>

    <button id="setFilterBtn">‚úÖ Appliquer</button>
  </fieldset>

  <fieldset>
    <legend>Tail Tone (bip de fin)</legend>
    <label>√âtat :</label>
    <select id="tail"><option value="0">OFF</option><option value="1">ON</option></select><br>
    <button id="setTailBtn">‚úÖ Appliquer</button>
  </fieldset>

  <div id="log"></div>

  <script>
    let port;
    let writer;
    let reader;

    // Liste standard CTCSS (38 tons)
    const ctcssFreqs = [
      67.0, 71.9, 74.4, 77.0, 79.7, 82.5, 85.4, 88.5, 91.5, 94.8,
      97.4,100.0,103.5,107.2,110.9,114.8,118.8,123.0,127.3,131.8,
      136.5,141.3,146.2,151.4,156.7,162.2,167.9,173.8,179.9,186.2,
      192.8,203.5,210.7,218.1,225.7,233.6,241.8,250.3
    ];

    function padCode(n) { return String(n).padStart(4,'0'); }

    function populateCtcss(selectId) {
      const sel = document.getElementById(selectId);
      sel.innerHTML = "";
      const offOpt = document.createElement("option");
      offOpt.value = "OFF";
      offOpt.text = "OFF";
      sel.appendChild(offOpt);
      for (let i = 0; i < ctcssFreqs.length; i++) {
        const freq = ctcssFreqs[i];
        const opt = document.createElement("option");
        opt.value = freq.toFixed(1);
        opt.text = `${freq.toFixed(1)} Hz`;
        sel.appendChild(opt);
      }
    }

    populateCtcss("txCss");
    populateCtcss("rxCss");

    function log(msg) {
      document.getElementById('log').innerHTML += msg + "\n";
      document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
    }

    async function readLoop() {
      while (port && port.readable) {
        reader = port.readable.getReader();
        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            if (value) {
              const text = new TextDecoder().decode(value).trim();
              if (!text) continue;
              log("‚¨ÖÔ∏è " + text);

              if (text.startsWith("+DMOREADGROUP:") || text.startsWith("+DMOREADGROUP=")) {
                let payload = text.replace("+DMOREADGROUP:","").replace("+DMOREADGROUP=","").trim();
                payload = payload.replace(/\r/g,'').replace(/\n/g,'').trim();
                const parts = payload.split(",");
                if (parts.length >= 6) {
                  document.getElementById("gbw").value = parts[0];
                  document.getElementById("txFreq").value = parts[1];
                  document.getElementById("rxFreq").value = parts[2];
                  setCtcssFromCode("txCss", parts[3]);
                  document.getElementById("squelch").value = parts[4];
                  setCtcssFromCode("rxCss", parts[5]);
                } else {
                  log("‚ö†Ô∏è R√©ponse inattendue: " + payload);
                }
              }
            }
          }
        } catch (err) {
          log("‚ùå Erreur lecture: " + err);
        } finally {
          try { reader.releaseLock(); } catch(e) {}
        }
      }
    }

    function setCtcssFromCode(selectId, code) {
      const sel = document.getElementById(selectId);
      if (code === "0000") {
        sel.value = "OFF";
      } else {
        const idx = parseInt(code,10);
        if (!isNaN(idx) && idx>=1 && idx<=38) {
          sel.value = ctcssFreqs[idx-1].toFixed(1);
        } else {
          // valeur inconnue -> l'ajouter brute
          let opt = document.createElement("option");
          opt.value = code;
          opt.text = `Code brut ${code}`;
          sel.appendChild(opt);
          sel.value = code;
        }
      }
    }

    function getCtcssCode(selectId) {
      const sel = document.getElementById(selectId);
      const val = sel.value;
      if (val === "OFF") return "0000";
      const freq = parseFloat(val);
      const idx = ctcssFreqs.indexOf(freq);
      if (idx >= 0) return padCode(idx+1);
      return val; // fallback (si code brut ajout√©)
    }

    async function sendCommand(cmd) {
      if (!writer) { log("‚ö†Ô∏è Connectez d'abord un port COM"); return; }
      log("‚û°Ô∏è " + cmd);
      try { await writer.write(new TextEncoder().encode(cmd + "\r\n")); }
      catch (e) { log("‚ùå Erreur √©criture: " + e); }
    }

    document.getElementById('connectBtn').addEventListener('click', async () => {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        writer = port.writable.getWriter();
        log("‚úÖ Port ouvert (9600,8,1,none)");
        readLoop();
      } catch (err) {
        log("‚ùå Erreur: " + err);
      }
    });

    document.getElementById('readConfigBtn').addEventListener('click', () => {
      sendCommand("AT+DMOREADGROUP");
    });

    document.getElementById('readVersionBtn').addEventListener('click', () => {
      sendCommand("AT+VERSION");
    });

    document.getElementById('setGroupBtn').addEventListener('click', () => {
      const cmd = `AT+DMOSETGROUP=${document.getElementById("gbw").value},${document.getElementById("txFreq").value},${document.getElementById("rxFreq").value},${getCtcssCode("txCss")},${document.getElementById("squelch").value},${getCtcssCode("rxCss")}`;
      sendCommand(cmd);
    });

    document.getElementById('setVolumeBtn').addEventListener('click', () => {
      sendCommand(`AT+DMOSETVOLUME=${document.getElementById("volume").value}`);
    });

    document.getElementById('setFilterBtn').addEventListener('click', () => {
      sendCommand(`AT+SETFILTER=${document.getElementById("preemph").value},${document.getElementById("highpass").value},${document.getElementById("lowpass").value}`);
    });

    document.getElementById('setTailBtn').addEventListener('click', () => {
      sendCommand(`AT+SETTAIL=${document.getElementById("tail").value}`);
    });
  </script>
</body>
</html>

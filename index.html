<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Configuration SA818</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    fieldset { margin-bottom: 20px; padding: 15px; border-radius: 8px; }
    legend { font-weight: bold; }
    label { display: inline-block; width: 160px; margin-bottom: 6px; }
    input, select { padding: 4px; margin-bottom: 8px; }
    button { margin-top: 10px; padding: 6px 12px; }
    #log { border: 1px solid #ccc; padding: 10px; margin-top: 15px; height: 200px; overflow-y: auto; background: #f9f9f9; }
  </style>
</head>
<body>
  <h1>Contr√¥le du module SA818</h1>

  <button id="connectBtn">üîå Choisir un port COM</button>
  <button id="readConfigBtn">üìñ Lire configuration</button>
  <button id="readVersionBtn">‚ÑπÔ∏è Lire version</button>

  <fieldset>
    <legend>Groupe (fr√©quences, CTCSS, SQ)</legend>
    <label>Bande passante :</label>
    <select id="gbw">
      <option value="0">12.5 kHz</option>
      <option value="1">25 kHz</option>
    </select><br>

    <label>Fr√©quence TX (MHz) :</label>
    <input type="text" id="txFreq" value="433.5000"><br>

    <label>Fr√©quence RX (MHz) :</label>
    <input type="text" id="rxFreq" value="433.5000"><br>

    <label>CTCSS/CDCSS TX :</label>
    <input type="text" id="txCss" value="0000"><br>

    <label>Niveau Squelch :</label>
    <input type="number" id="squelch" min="0" max="8" value="4"><br>

    <label>CTCSS/CDCSS RX :</label>
    <input type="text" id="rxCss" value="0000"><br>

    <button id="setGroupBtn">‚úÖ Appliquer</button>
  </fieldset>

  <fieldset>
    <legend>Volume</legend>
    <label>Niveau :</label>
    <input type="number" id="volume" min="1" max="8" value="4"><br>
    <button id="setVolumeBtn">‚úÖ Appliquer</button>
  </fieldset>

  <fieldset>
    <legend>Filtres</legend>
    <label>Pr√©/d√©-emphasis :</label>
    <select id="preemph"><option value="0">ON</option><option value="1">OFF</option></select><br>

    <label>High-pass :</label>
    <select id="highpass"><option value="0">ON</option><option value="1">OFF</option></select><br>

    <label>Low-pass :</label>
    <select id="lowpass"><option value="0">ON</option><option value="1">OFF</option></select><br>

    <button id="setFilterBtn">‚úÖ Appliquer</button>
  </fieldset>

  <fieldset>
    <legend>Tail Tone (bip de fin)</legend>
    <label>√âtat :</label>
    <select id="tail"><option value="0">OFF</option><option value="1">ON</option></select><br>
    <button id="setTailBtn">‚úÖ Appliquer</button>
  </fieldset>

  <div id="log"></div>

  <script>
    let port;
    let writer;
    let reader;

    function log(msg) {
      document.getElementById('log').innerHTML += msg + "<br>";
      document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
    }

    async function readLoop() {
      while (port.readable) {
        reader = port.readable.getReader();
        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            if (value) {
              const text = new TextDecoder().decode(value);
              log("‚¨ÖÔ∏è " + text);

              // si r√©ponse au DMOREADGROUP ‚Üí remplir formulaire
              if (text.startsWith("+DMOREADGROUP:")) {
                const parts = text.replace("+DMOREADGROUP:","").trim().split(",");
                if (parts.length === 6) {
                  document.getElementById("gbw").value = parts[0];
                  document.getElementById("txFreq").value = parts[1];
                  document.getElementById("rxFreq").value = parts[2];
                  document.getElementById("txCss").value = parts[3];
                  document.getElementById("squelch").value = parts[4];
                  document.getElementById("rxCss").value = parts[5];
                }
              }
            }
          }
        } catch (err) {
          log("‚ùå Erreur lecture: " + err);
        } finally {
          reader.releaseLock();
        }
      }
    }

    async function sendCommand(cmd) {
      if (!writer) {
        log("‚ö†Ô∏è Connectez d'abord un port COM");
        return;
      }
      log("‚û°Ô∏è " + cmd);
      await writer.write(new TextEncoder().encode(cmd + "\r\n"));
    }

    document.getElementById('connectBtn').addEventListener('click', async () => {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        writer = port.writable.getWriter();
        log("‚úÖ Port ouvert");
        readLoop();
      } catch (err) {
        log("‚ùå Erreur: " + err);
      }
    });

    document.getElementById('readConfigBtn').addEventListener('click', () => {
      sendCommand("AT+DMOREADGROUP");
    });

    document.getElementById('readVersionBtn').addEventListener('click', () => {
      sendCommand("AT+VERSION");
    });

    document.getElementById('setGroupBtn').addEventListener('click', () => {
      const cmd = `AT+DMOSETGROUP=${document.getElementById("gbw").value},${document.getElementById("txFreq").value},${document.getElementById("rxFreq").value},${document.getElementById("txCss").value},${document.getElementById("squelch").value},${document.getElementById("rxCss").value}`;
      sendCommand(cmd);
    });

    document.getElementById('setVolumeBtn').addEventListener('click', () => {
      const cmd = `AT+DMOSETVOLUME=${document.getElementById("volume").value}`;
      sendCommand(cmd);
    });

    document.getElementById('setFilterBtn').addEventListener('click', () => {
      const cmd = `AT+SETFILTER=${document.getElementById("preemph").value},${document.getElementById("highpass").value},${document.getElementById("lowpass").value}`;
      sendCommand(cmd);
    });

    document.getElementById('setTailBtn').addEventListener('click', () => {
      const cmd = `AT+SETTAIL=${document.getElementById("tail").value}`;
      sendCommand(cmd);
    });
  </script>
</body>
</html>

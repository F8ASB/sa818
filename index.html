<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Lecture SA818</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { margin-top: 10px; padding: 8px 12px; }
    #log { border: 1px solid #ccc; padding: 10px; margin-top: 15px; height: 200px; overflow-y: auto; background: #f9f9f9; }
  </style>
</head>
<body>
  <h1>Lecture configuration SA818</h1>

  <button id="connectBtn">Choisir un port COM</button>
  <button id="readConfigBtn">Lire configuration</button>
  <button id="readVersionBtn">Lire version</button>

  <div id="log"></div>

  <script>
    let port;
    let writer;
    let reader;

    function log(msg) {
      document.getElementById('log').innerHTML += msg + "<br>";
    }

    async function readLoop() {
      while (port.readable) {
        reader = port.readable.getReader();
        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            if (value) {
              log("⬅️ Réponse: " + new TextDecoder().decode(value));
            }
          }
        } catch (err) {
          log("❌ Erreur lecture: " + err);
        } finally {
          reader.releaseLock();
        }
      }
    }

    document.getElementById('connectBtn').addEventListener('click', async () => {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        writer = port.writable.getWriter();
        log("✅ Port ouvert");
        readLoop();
      } catch (err) {
        log("❌ Erreur: " + err);
      }
    });

    document.getElementById('readConfigBtn').addEventListener('click', async () => {
      if (!writer) {
        log("⚠️ Connectez d'abord un port COM");
        return;
      }
      const cmd = "AT+DMOREADGROUP\r\n";
      log("➡️ Envoi: " + cmd);
      await writer.write(new TextEncoder().encode(cmd));
    });

    document.getElementById('readVersionBtn').addEventListener('click', async () => {
      if (!writer) {
        log("⚠️ Connectez d'abord un port COM");
        return;
      }
      const cmd = "AT+VERSION\r\n";
      log("➡️ Envoi: " + cmd);
      await writer.write(new TextEncoder().encode(cmd));
    });
  </script>
</body>
</html>
